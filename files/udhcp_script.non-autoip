#!/bin/sh

# udhcpc script edited by Tim Riker <Tim@Rikers.org>

[ -z "$1" ] && echo "Error: should be called from udhcpc" && exit 1

TEMP_DHCP_FILE="/tmp/udhcpc_dyn.tmp"
UDHCPC_LOG="/tmp/udhcpc_log"

BRD_ADDR="+"
NET_ADDR="$ip/24"

/usr/bin/env > /tmp/test_env

[ -n "$subnet" ] && NET_ADDR="$ip/$subnet"
[ -n "$broadcast" ] && BRD_ADDR="$broadcast"

case "$1" in
	deconfig)
		/sbin/ifconfig $interface 0.0.0.0
		;;

	renew|bound)
		/sbin/ifconfig $interface $ip $BROADCAST $NETMASK up
		echo "$interface $ip $BROADCAST $NETMASK" >> $UDHCPC_LOG
#		if [ -n "$router" ] ; then
#			echo "deleting routers" >> $UDHCPC_LOG
#			while /sbin/route del default gw 0.0.0.0 dev $interface 2>/dev/null ; do
#				:
#			done
#
#			for i in $router ; do
#				echo "router $i" >> $UDHCPC_LOG
#				/sbin/route add default gw $i dev $interface
#			done
#		fi

		echo serveraddr $serverid >> $TEMP_DHCP_FILE
		echo leasetime $lease >> $TEMP_DHCP_FILE

		if [ -n $router ]; then
			for i in $router ; do
# Take the first router
				echo "/sbin/route $i"
				local_gateway=$i
				break
			done
		fi
		if [ -z $subnet ]; then
			subnet="255.255.255.0"
		fi
		if [ -z $local_gateway ]; then
			local_gateway="0.0.0.0"
		fi

		/usr/bin/vconftool set -t string memory/private/wifi_direct_manager/p2p_ifname ${interface} -f
		/usr/bin/vconftool set -t string memory/private/wifi_direct_manager/p2p_subnet_mask ${subnet} -f
		/usr/bin/vconftool set -t string memory/private/wifi_direct_manager/p2p_gateway ${local_gateway} -f
		/usr/bin/vconftool set -t string memory/private/wifi_direct_manager/dhcpc_server_ip ${serverid} -f
		/usr/bin/vconftool set -t string memory/private/wifi_direct_manager/p2p_local_ip ${ip} -f
		echo $i >> $TEMP_DHCP_FILE
		;;
esac

exit 0
